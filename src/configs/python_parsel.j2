"""
Auto generated code by selector_schema_codegen

id: {{ info.id }}
name: {{ info.name }}
author: {{ info.author }}
description:
    {{ info.description }}
source: {{ info.source }}
tags:
    {{ info.tags }}

WARNING: Any manual changes made to this file will be lost when selector_generate
is run again.  Do not edit this file unless you know what you are doing.
"""

from typing import Any
import re

from parsel import Selector

{% for schema in schemas %}
class {{ schema.name }}:
    """
    {{ schema.doc }}
    """
    {% for const in schema.constants -%}
    {%- for const_key, value in const.items() -%}
    {{ const_key }} = {{ repr_str(value) -}}
    {% endfor %}
    {% endfor %}
    def __init__(self, document: str):
        self.__raw__ = document
        self.__selector__ = Selector(document)
        self.__aliases = {{ schema.aliases }}
        self.__view_keys = {{ schema.view_keys }}
        self.__cached_result: list[dict[str, Any]] = []

        self.__start_parse()

    @staticmethod
    def __pre_validate(val: Selector):
        {{ "\n        ".join(schema.generate_pre_validate_code(translator).code.split("\n")) }}

    def __part_document(self, val):
        self.__pre_validate(self.__selector__)
        {{ "\n        ".join(schema.generate_split_code(translator).code.split("\n")) }}
    {% for attr in schema.attrs %}
    @staticmethod
    def __parse_{{ attr.name }}(val):
        {{ "\n        ".join(attr.generate_code(translator).code.split("\n")) }}
    {% endfor %}
    def __start_parse(self):
        for part in self.__part_document(self.__selector__):
            result: dict[str, Any] = {}
            {% for key in schema.attrs_names -%}
                 result[{{ repr_str(key) }}] = self.__parse_{{ key }}(part)
            {% endfor -%}
            self.__cached_result.append(result)

    def view(self) -> list[dict[str, Any]]:
        def map_fields(result):
            view_dict = {}
            for k in self.__view_keys:
                if v := result.get(k):
                    k = self.__aliases.get(k, k)
                    view_dict[k] = v
                elif v := getattr(self,k, None):
                    view_dict[k] = v
            return view_dict

        if len(self.__cached_result) == 1:
            return [map_fields(self.__cached_result[0])]
        return [map_fields(result) for result in self.__cached_result]
{% endfor %}